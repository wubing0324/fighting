<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>
<body>
  <canvas id='canvas'></canvas>
  <script>
    // var canvas = document.getElementById('canvas');
    // canvas.width = 100;
    // canvas.height = 100;
    // var context = canvas.getContext('2d');
    // context.fillStyle = '#94f';
    // context.fillRect(0, 0, canvas.width, canvas.height);
    // var imgData = context.getImageData(0, 0, canvas.width, canvas.height);
    // var buffer32 = new Uint32Array(imgData.data.buffer);
    // console.log(buffer32);

    var canvas = document.getElementById('canvas');
    context = canvas.getContext('2d');
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    gridY = 7, gridX = 7;
    var radVal = 2;
    var graVal = -3;
    var durVal = .5;
    var spdVal = 0;
    var message = '你来看我啦,好久不见';

    type = "ball";

    colors = [
    '#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5',
    '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50',
    '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800',
    '#FF5722'
    ];

    function randomInt(min, max) {
      return min + Math.random() * (max - min + 1);
    }
    function Particle(x, y, type) {
      this.radius = 1.1;
      this.futurRadius = randomInt(radVal, radVal+3); //[1.1,5.1]
      
      this.rebond = randomInt(1, 5);
      this.x = x;
      this.y = y;
      
      this.dying = false;
      
      this.base = [x, y];

      this.vx = 0;
      this.vy = 0;
      this.type = type;
      this.friction = .99;
      this.gravity = graVal;
      this.color = colors[Math.floor(Math.random() * colors.length)];

      this.getSpeed = function() {
        return Math.sqrt(this.vx * this.vx + this.vy * this.vy);
      };

      this.setSpeed = function(speed) {
        var heading = this.getHeading();
        this.vx = Math.cos(heading) * speed;
        this.vy = Math.sin(heading) * speed;
      };

      this.getHeading = function() {
        return Math.atan2(this.vy, this.vx);
      };

      this.setHeading = function(heading) {
        var speed = this.getSpeed();
        this.vx = Math.cos(heading) * speed;
        this.vy = Math.sin(heading) * speed;
      };

      this.update = function(heading) {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += graVal;

        this.vx *= this.friction;
        this.vy *= this.friction;
        
        if(this.radius < this.futurRadius && this.dying === false){
          this.radius += durVal;
        }else{
          this.dying = true;
        }
          
        if(this.dying === true){
          this.radius -= durVal;
        }
        
        if(type === "ball"){
          context.save();
          context.fillStyle = this.color;
          context.beginPath();
          context.arc(this.x, this.y, this.radius, Math.PI * 2, false);
          context.closePath();
          context.fill();
          context.restore();
        }

        if(type === "rect"){
          context.save();
          context.fillStyle = this.color;
          context.beginPath();
          context.fillRect(this.x, this.y, this.futurRadius, this.futurRadius)
          context.closePath();
          context.fill();
          context.restore();
        }
        

        if (this.y < 0 || this.radius < 1) {
          this.x = this.base[0];
          this.y = this.base[1];
          this.dying = false;
          this.radius = 1.1;
          this.setSpeed(spdVal);
          this.futurRadius = randomInt(radVal, radVal+3);  
        }

      }

      this.setSpeed(randomInt(.1, .5));

    }



    function Shape(x, y, texte){
      this.x = x;
      this.y = y;
      this.size = 150;

      this.text = texte;
      this.placement = [];
    }
    Shape.prototype.getValue = function(){

      //draw the shape
      context.textAlign = "center";
      context.font =  this.size + "px arial";
      context.fillText(this.text, this.x, this.y);

      var idata = context.getImageData(0, 0, W, H);
      var buffer32 = new Uint32Array(idata.data.buffer);

      for(var j=0; j < H; j += gridY){
        for(var i=0 ; i < W; i += gridX){
          if(buffer32[j * W + i]){
            var particle = new Particle(i, j, type);
            this.placement.push(particle);
          }
        }
      }
      context.clearRect(0, 0, W, H);
    }

    var word = new Shape(W/2, H/2, message);
	  word.getValue();

    (function drawFrame(){
      window.requestAnimationFrame(drawFrame, canvas);
      context.clearRect(0, 0, W, H);

      for(var i=0; i< word.placement.length; i++){
        word.placement[i].update();
      }
    }())
    var timer = setInterval(function(){
      if (graVal > 0) {
        clearInterval(timer)
        graVal = 0;
        return
      }
      graVal = graVal + 0.6
    }, 1000)
  </script>
</body>
</html>